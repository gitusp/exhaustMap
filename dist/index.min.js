(function(global,factory){typeof exports==="object"&&typeof module!=="undefined"?factory(exports):typeof define==="function"&&define.amd?define(["exports"],factory):factory(global["most-exhaust-map"]={})})(this,function(exports){"use strict";function append(x,a){var l=a.length;var b=new Array(l+1);for(var i=0;i<l;++i){b[i]=a[i]}b[l]=x;return b}function reduce(f,z,a){var r=z;for(var i=0,l=a.length;i<l;++i){r=f(r,a[i],i)}return r}function curry2(f){function curried(a,b){switch(arguments.length){case 0:return curried;case 1:return function(b){return f(a,b)};default:return f(a,b)}}return curried}function curry3(f){function curried(a,b,c){switch(arguments.length){case 0:return curried;case 1:return curry2(function(b,c){return f(a,b,c)});case 2:return function(c){return f(a,b,c)};default:return f(a,b,c)}}return curried}var classCallCheck=function(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}};var disposeNone=function disposeNone(){return NONE};var NONE=new(function(){function DisposeNone(){classCallCheck(this,DisposeNone)}DisposeNone.prototype.dispose=function dispose(){};return DisposeNone}());var isDisposeNone=function isDisposeNone(d){return d===NONE};var disposeAll=function disposeAll(ds){var merged=reduce(merge,[],ds);return merged.length===0?disposeNone():new DisposeAll(merged)};var disposeBoth=curry2(function(d1,d2){return disposeAll([d1,d2])});var merge=function merge(ds,d){return isDisposeNone(d)?ds:d instanceof DisposeAll?ds.concat(d.disposables):append(d,ds)};var DisposeAll=function(){function DisposeAll(disposables){classCallCheck(this,DisposeAll);this.disposables=disposables}DisposeAll.prototype.dispose=function dispose(){throwIfErrors(disposeCollectErrors(this.disposables))};return DisposeAll}();var disposeCollectErrors=function disposeCollectErrors(disposables){return reduce(appendIfError,[],disposables)};var appendIfError=function appendIfError(errors,d){try{d.dispose()}catch(e){errors.push(e)}return errors};var throwIfErrors=function throwIfErrors(errors){if(errors.length>0){throw new DisposeAllError(errors.length+" errors",errors)}};var DisposeAllError=function(Error){function DisposeAllError(message,errors){Error.call(this,message);this.message=message;this.name=DisposeAllError.name;this.errors=errors;if(Error.captureStackTrace){Error.captureStackTrace(this,DisposeAllError)}this.stack=""+this.stack+formatErrorStacks(this.errors)}DisposeAllError.prototype=Object.create(Error.prototype);return DisposeAllError}(Error);var formatErrorStacks=function formatErrorStacks(errors){return reduce(formatErrorStack,"",errors)};var formatErrorStack=function formatErrorStack(s,e,i){return s+("\n["+(i+1)+"] "+e.stack)};var tryDispose=curry3(function(t,disposable,sink){try{disposable.dispose()}catch(e){sink.error(t,e)}});var classCallCheck$1=function(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}};var RelativeScheduler=function(){function RelativeScheduler(origin,scheduler){classCallCheck$1(this,RelativeScheduler);this.origin=origin;this.scheduler=scheduler}RelativeScheduler.prototype.currentTime=function currentTime(){return this.scheduler.currentTime()-this.origin};RelativeScheduler.prototype.scheduleTask=function scheduleTask(localOffset,delay,period,task){return this.scheduler.scheduleTask(localOffset+this.origin,delay,period,task)};RelativeScheduler.prototype.relative=function relative(origin){return new RelativeScheduler(origin+this.origin,this.scheduler)};RelativeScheduler.prototype.cancel=function cancel(task){return this.scheduler.cancel(task)};RelativeScheduler.prototype.cancelAll=function cancelAll(f){return this.scheduler.cancelAll(f)};return RelativeScheduler}();var currentTime=function currentTime(scheduler){return scheduler.currentTime()};var schedulerRelativeTo=curry2(function(offset,scheduler){return new RelativeScheduler(offset,scheduler)});var exhaustMap=curry2(_exhaustMap);function _exhaustMap(fn,stream){return new ExhaustMap(fn,stream)}var ExhaustMap=function(){function ExhaustMap(fn,source){this.fn=fn;this.source=source}ExhaustMap.prototype.run=function(sink,scheduler){var exhaustMapSink=new ExhaustMapSink(this.fn,sink,scheduler);return disposeBoth(exhaustMapSink,this.source.run(exhaustMapSink,scheduler))};return ExhaustMap}();var ExhaustMapSink=function(){function ExhaustMapSink(fn,sink,scheduler){this.fn=fn;this.sink=sink;this.scheduler=scheduler;this.ended=false}ExhaustMapSink.prototype.event=function(t,value){if(this.current===undefined){var segment=new Segment(t,this,this.sink);this.current=this.fn(value).run(segment,schedulerRelativeTo(t,this.scheduler))}};ExhaustMapSink.prototype.end=function(t){this.ended=true;this._checkEnd(t)};ExhaustMapSink.prototype.error=function(t,error){this.ended=true;this.sink.error(t,error)};ExhaustMapSink.prototype.dispose=function(){this._disposeCurrent(currentTime(this.scheduler))};ExhaustMapSink.prototype._disposeCurrent=function(t){if(this.current!==undefined){tryDispose(t,this.current,this.sink);this.current=undefined}};ExhaustMapSink.prototype._endInner=function(t){this._disposeCurrent(t);this._checkEnd(t)};ExhaustMapSink.prototype._errorInner=function(t,error){this._disposeCurrent(t);this.sink.error(t,error)};ExhaustMapSink.prototype._checkEnd=function(t){if(this.ended&&this.current===undefined){this.sink.end(t)}};return ExhaustMapSink}();var Segment=function(){function Segment(time,outer,sink){this.time=time;this.outer=outer;this.sink=sink}Segment.prototype.event=function(t,value){this.sink.event(t+this.time,value)};Segment.prototype.end=function(t){this.outer._endInner(t+this.time)};Segment.prototype.error=function(t,error){this.outer._errorInner(t+this.time,error)};return Segment}();exports.exhaustMap=exhaustMap;Object.defineProperty(exports,"__esModule",{value:true})});